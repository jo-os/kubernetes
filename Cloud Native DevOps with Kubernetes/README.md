# Kubernetes

**Дирижирование оркестром контейнеров**

Оркестратор контейнеров: программный компонент, предназначенный для объединения множества разных серверов в кластер Кластер — это своего рода унифицированная вычислительная подложка, которая, с точки зрения пользователя, выглядит как компьютер очень высокой мощности, способный работать с контейнерами.

Термин «оркестратор контейнеров» обычно относится к одному сервису, который занимается планированием и оркестрацией кластера, а также управлением им.
- Оркестрация означает координацию и выстраивание цепочки из разных действий для достижения общей цели. 
- Планирование же означает управление доступными ресурсами и направление рабочих заданий туда, где они могут быть выполнены наиболее эффективно.
- Управление кластером является объединение нескольких физических или виртуальных серверов в унифицированную, надежную, отказоустойчивую и довольно цельную группу

В 2014 году компания Google основала открытый проект под названием Kubernetes (от греческого слова — «рулевой, пилот»).

**Что делает платформу Kubernetes такой ценной**

Kubernetes занимается тем же, чем и самые лучшие системные администраторы: автоматизацией, централизованным ведением журнала, мониторингом, обеспечивает отказоустойчивость. Балансировка нагрузки и автомасштабирование, встроены в ядро Kubernetes, Kubernetes отличается обширной и постоянно растущей экосистемой.

**Kubernetes облегчает развертывание**
- Благодаря тому что Kubernetes выполняет плавающие обновления по умолчанию, приобрели популярность развертывания с нулевым временем простоя
- Kubernetes поддерживает автомасштабирование
- Избыточность и отказоустойчивость встроены в Kubernetes

**Kubernetes не решает все проблемы**
- Kubernetes просто не очень хорошо подходит для некоторых структур (таких как базы данных).
- некоторые задачи не требуют Kubernetes и могут работать на платформах, которые иногда называют бессерверными (функции как сервис (functions as a service, FaaS))

**Облачная ориентированность**

Термин «облачно-ориентированный» (cloud native) становится все более популярным сокращением, которое описывает современные приложения и сервисы, пользующиеся преимуществами облаков, контейнеров и оркестрации

Характеристики облачно-ориентированных систем:
- Автоматизируемость
- Универсальность и гибкость
- Устойчивость и масштабируемость
- Динамичность
- Наблюдаемость
- Распределенность

# Первые шаги с Kubernetes

Запуск приложения
```
kubectl run demo --image=cloudnatived/demo:hello --port=9999 --labels app=demo deployment.apps "demo" created
```
Перенаправление портов
```
kubectl port-forward deploy/demo 9999:8888
```
Просмотр pods
```
kubectl get pods --selector app=demo
```
# Размещение Kubernetes

**Архитектура кластера**

«Мозг» кластера называется **управляющим уровнем**. Управляющий уровень на самом деле состоит из нескольких компонентов.
- kube-apiserver — это внешний сервер для управляющего уровня, который обрабатывает API-запросы
- etcd — база данных, в которой Kubernetes хранит всю информацию о существующих узлах, ресурсах кластера
- kube-scheduler определяет, где будут запущены свежесозданные pod-оболочки.
- kube-controller-manager отвечает за запуск контроллеров ресурсов, таких как развертывания.
- cloud-controller-manager взаимодействует с облачным провайдером (в облачных кластерах), управляя такими ресурсами, как балансировщики нагрузки и дисковые тома.

Участники кластера, которые **выполняют компоненты управляющего уровня**, называются **ведущими узлами**.

Участники кластера, которые **выполняют пользовательские рабочие задания**, называются **рабочими узлами**.

Каждый рабочий узел в кластере Kubernetes отвечает за следующие компоненты.
- kubelet отвечает за управление средой выполнения контейнера, в которой запускаются рабочие задания, запланированные для узла, а также за мониторинг их состояния.
- kube-proxy занимается сетевой магией, которая распределяет запросы между pod-оболочками на разных узлах, а также между pod-оболочками и Интернетом.
- Среда выполнения контейнеров запускает и останавливает контейнеры, а также отвечает за их взаимодействие.

**Высокая доступность**

У правильно сконфигурированного управляющего уровня Kubernetes есть несколько ведущих узлов, что делает его высокодоступным. База данных etcd реплицируется между несколькими узлами и может пережить отказ отдельных копий при условии наличия кворума из более чем половины реплик etcd.

**Отказ управляющего уровня**

Если вы остановите все ведущие узлы в своем кластере, pod-оболочки на рабочих узлах продолжат функционировать — по крайней мере какое-то время. Однако вы не сможете развертывать новые контейнеры или менять какие-либо ресурсы Kubernetes, а такие контроллеры, как развертывания, перестанут действовать.

Вам необходимо запастись достаточным количеством ведущих узлов, чтобы кластер мог поддерживать кворум, даже если какой-то из узлов откажет. Для промышленных кластеров реалистичным минимумом является три узла.

**Отказ рабочего узла**

Отказ любого рабочего узла, не влечет за собой никаких существенных последствий: Kubernetes обнаружит сбой и перераспределит pod-оболочки этого узла. Главное, чтобы работал управляющий уровень.

**Установщики Kubernetes**

**kops** (kubernetes.io/docs/setup/production-environment/tools/kops) — это утилита командной строки для автоматического выделения кластеров, служит инструментом, предназначенным специально для AWS.

**Kubespray** фокусируется на установке Kubernetes на существующие компьютеры, особенно на локальные и физические серверы. Это инструмент для простого развертывания промышленных кластеров. Он предлагает множество возможностей, включая высокую доступность и поддержку нескольких платформ.

**TK8** (github.com/kubernauts/tk8) — утилита командной строки для создания кластеров Kubernetes, которая использует как Terraform (для создания облачных серверов), так и Kubespray (для установки на них Kubernetes). Она написана на Go и поддерживает установку на AWS, OpenStack и «чистые серверы». 

**Kubernetes: трудный путь**

**kubeadm** - Утилита kubeadm (kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm) входит в состав дистрибутива Kubernetes и должна помочь вам устанавливать и обслуживать кластеры в соответствии с лучшими рекомендациями. Многие инструменты и сервисы, используют kubeadm для выполнения административных операций,

**Tarmak** (blog.jetstack.io/blog/introducing-tarmak) — это инструмент для управления жизненным циклом кластеров Kubernetes, который должен упростить и сделать более надежными модификацию и обновления кластерных узлов. Tarmak использует Terraform для выделения узлов кластера и Puppet для управления конфигурацией на самих узлах.

**Rancher Kubernetes Engine** - RKE (github.com/rancher/rke) стремится быть простым и быстрым установщиком Kubernetes.

# Работа с объектами Kubernetes
